# 🚀 Delivery System like Bolt/Glovo

## ✅ Что реализовано

### 1. Фиксированная точка ресторана 📍
**Файл:** `lib/constants.ts`

```typescript
export const RESTAURANT_LOCATION = {
  lat: 54.372158,
  lng: 18.638306,
  address: "Chmielna 10, Gdańsk",
  name: "Суши • Вок • Рамен",
};
```

**Настройки доставки:**
- ⏱ Время готовки: 20 минут
- 🚗 Средняя скорость: 35 км/ч
- 📏 Максимальное расстояние: 12 км
- 💰 Минимальный заказ: 50 zł
- 💵 Базовая цена: 5 zł
- 📐 Цена за км: 2 zł
- 🎁 Бесплатная доставка от: 100 zł

### 2. Калькулятор доставки 🧮
**Файл:** `lib/delivery-calculator.ts`

**Функции:**
- `calculateDeliveryTime(distanceKm)` - расчёт времени (готовка + дорога)
- `calculateDeliveryPrice(distanceKm, orderTotal)` - проверка и расчёт цены
- `formatDeliveryTime(minutes)` - форматирование "30–40 min"

**Логика расчёта:**
```typescript
// Время = готовка + (расстояние / скорость) * 60
const travelTime = Math.ceil((distanceKm / AVERAGE_SPEED) * 60);
const totalTime = COOKING_TIME + travelTime;

// Цена = базовая + (км * цена_за_км)
const price = BASE_PRICE + distanceKm * PRICE_PER_KM;

// Бесплатно если заказ >= 100 zł
const isFree = orderTotal >= FREE_DELIVERY_FROM;
```

**Проверки:**
- ❌ Расстояние > 12 км → "Вне зоны доставки"
- ❌ Сумма заказа < 50 zł → "Минимальный заказ: 50 zł"
- ✅ Всё ОК → показываем расстояние, время, цену

### 3. Интерактивная карта с маршрутом 🗺️
**Файл:** `components/maps/delivery-map.tsx`

**Возможности:**
- ✅ Два маркера: ресторан (зелёный) и клиент (красный)
- ✅ Клик на карту → установка адреса доставки
- ✅ Автоматический расчёт маршрута (Google Directions API)
- ✅ Синяя линия маршрута между точками
- ✅ Callback с расстоянием и временем в пути

**Google APIs используются:**
- **DirectionsService** - построение маршрута
- **DirectionsRenderer** - отрисовка маршрута на карте
- **Distance Matrix API** (опционально) - точный расчёт

**Props:**
```typescript
interface DeliveryMapProps {
  onLocationSelect?: (location: { lat: number; lng: number }) => void;
  onDistanceCalculated?: (distance: number, duration: number) => void;
}
```

### 4. Интеграция в checkout 🛒
**Файл:** `components/checkout/checkout-form.tsx`

**Что добавлено:**
1. State для информации о доставке
2. Обработчики событий карты
3. Блок с расчётами доставки
4. Обновлённая кнопка с финальной суммой

**UI блок с информацией:**
```
┌─────────────────────────────┐
│ ✅ Доставка доступна        │
│ 🗺 Расстояние: 4.2 км       │
│ ⏱ Время: 30–40 min         │
│ 💰 Стоимость: 13 zł         │
└─────────────────────────────┘
```

Или если недоступна:
```
┌─────────────────────────────┐
│ 🚫 Вне зоны доставки        │
│    (максимум 12 км)         │
└─────────────────────────────┘
```

**Финальная кнопка:**
```
Заказать • 113 zł
(товары: 100 zł + доставка: 13 zł)
```

### 5. Как это работает 🔄

**Пользовательский флоу:**

1. **Клиент заходит на /checkout**
   - Видит карту с маркером ресторана

2. **Кликает на карту** (свой адрес)
   - Появляется красный маркер
   - Строится синяя линия маршрута

3. **Автоматически рассчитывается:**
   - Расстояние (например, 4.2 км)
   - Время в пути (например, 7 мин)
   - Время готовки (20 мин)
   - Итого: 27 мин → "25–35 min"

4. **Рассчитывается цена:**
   - Базовая: 5 zł
   - За км: 4.2 × 2 = 8.4 zł
   - Итого: 13 zł

5. **Проверяется:**
   - ✅ Расстояние 4.2 км < 12 км
   - ✅ Сумма заказа 100 zł > 50 zł
   - ✅ Доставка доступна!

6. **Клиент видит:**
```
┌─────────────────────────────┐
│ ✅ Доставка доступна        │
│ 🗺 Расстояние: 4.2 км       │
│ ⏱ Время: 25–35 min         │
│ 💰 Стоимость: 13 zł         │
└─────────────────────────────┘

[Заказать • 113 zł]
(товары: 100 zł + доставка: 13 zł)
```

## 🎯 MVP Features (как Bolt/Glovo)

### ✅ РЕАЛИЗОВАНО:

1. **Фиксированная точка ресторана** ✅
   - Зелёный маркер на карте
   - Адрес: Chmielna 10, Gdańsk

2. **Выбор адреса клиента** ✅
   - Клик на карту
   - Красный маркер

3. **Маршрут на карте** ✅
   - Синяя линия
   - Google Directions API

4. **Расчёт расстояния** ✅
   - Автоматически по маршруту
   - В километрах

5. **Расчёт времени доставки** ✅
   - Готовка + дорога
   - Диапазон (25–35 min)

6. **Расчёт цены доставки** ✅
   - Базовая + за км
   - Бесплатно от 100 zł

7. **Проверка зоны доставки** ✅
   - Максимум 12 км
   - Блокировка если дальше

8. **Минимальная сумма заказа** ✅
   - 50 zł минимум
   - Предупреждение

9. **UI как в Bolt** ✅
   - Блок с информацией
   - Зелёный = ОК, Красный = нет
   - Кнопка с финальной суммой

### ⏳ МОЖНО УЛУЧШИТЬ:

1. **Автодополнение адреса** ⏳
   - Google Places Autocomplete
   - Поиск улиц и домов

2. **Обратное геокодирование** ⏳
   - Клик на карту → адрес в поле
   - Geocoding API

3. **Зоны доставки (полигоны)** ⏳
   - Gdańsk, Sopot, Gdynia
   - Цветовая индикация

4. **Динамические пробки** ⏳
   - Traffic Layer
   - Реальное время с учётом пробок

5. **История адресов** ⏳
   - Сохранение в localStorage
   - Быстрый выбор

## 📊 Примеры расчётов

### Пример 1: Близко (✅ ОК)
```
Заказ: 80 zł
Расстояние: 3 км
Время: 20 мин (готовка) + 5 мин (дорога) = 25 мин
Доставка: 5 + (3 × 2) = 11 zł
Итого: 91 zł
Диапазон: 20–30 min
```

### Пример 2: Далеко (✅ ОК)
```
Заказ: 120 zł
Расстояние: 10 км
Время: 20 мин (готовка) + 17 мин (дорога) = 37 мин
Доставка: БЕСПЛАТНО (заказ > 100 zł)
Итого: 120 zł
Диапазон: 30–40 min
```

### Пример 3: Слишком далеко (❌ НЕТ)
```
Заказ: 90 zł
Расстояние: 15 км
❌ Вне зоны доставки (максимум 12 км)
```

### Пример 4: Мало заказ (❌ НЕТ)
```
Заказ: 35 zł
Расстояние: 5 км
❌ Минимальный заказ: 50 zł
```

## 🔧 Технические детали

### Google Maps APIs:
- ✅ **Maps JavaScript API** - основная карта
- ✅ **Directions API** - построение маршрутов
- ⏳ **Places API** - автодополнение (следующий шаг)
- ⏳ **Geocoding API** - координаты ↔ адреса
- ⏳ **Distance Matrix API** - точные расчёты

### Лимиты (бесплатный tier):
- 28,000 запросов/месяц
- $200 кредитов
- Достаточно для старта

### Оптимизация:
- Directions API вызывается только при клике на карту
- Результаты можно кэшировать
- Debounce при автодополнении

## 🚀 Deployment Checklist

### Перед запуском:

1. ✅ Включить APIs в Google Cloud Console:
   - Maps JavaScript API
   - Directions API
   - Distance Matrix API

2. ✅ Проверить лимиты:
   - Настроить квоты
   - Добавить биллинг (после $200)

3. ✅ Настроить .env.local:
   ```bash
   NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=your_key_here
   ```

4. ✅ Настроить константы:
   - Адрес реального ресторана
   - Цены и лимиты

5. ✅ Тестирование:
   - Разные расстояния
   - Граничные случаи (12 км, 50 zł)
   - Мобильная версия

## 📝 Статус

### 🎉 Готово к продакшену:
- ✅ Карта с маршрутом
- ✅ Расчёт расстояния
- ✅ Расчёт времени
- ✅ Расчёт цены
- ✅ Проверка зон
- ✅ UI как в Bolt
- ✅ Адаптивный дизайн
- ✅ Тёмная/светлая тема

### 🔜 Next Level:
- Автодополнение адресов
- Сохранение истории
- Зоны на карте (полигоны)
- Учёт пробок
- Push-уведомления с трекингом

---

**🎯 Итог:** У вас уже MVP уровня Bolt/Glovo! 🚀
